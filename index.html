<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>xsukax Map Pin Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        #map { height: 400px; z-index: 1; border: 1px solid #d1d5db; }
        #map:fullscreen { width: 100vw; height: 100vh; }
        .pin-marker { display: flex; align-items: center; justify-content: center; background: #0969da; border: 2px solid white; border-radius: 50%; width: 24px; height: 24px; box-shadow: 0 2px 5px rgba(0,0,0,0.15); font-weight: 600; color: white; font-size: 10px; }
        .pin-label { position: absolute; top: -22px; left: 50%; transform: translateX(-50%); background: #24292f; color: white; padding: 2px 8px; border-radius: 6px; font-size: 11px; font-weight: 500; white-space: nowrap; box-shadow: 0 1px 3px rgba(0,0,0,0.12); }
        .fullscreen-btn { position: absolute; top: 10px; right: 10px; z-index: 1000; background: white; border: 1px solid #d1d5db; border-radius: 6px; padding: 6px 12px; cursor: pointer; font-size: 13px; }
        .fullscreen-btn:hover { background: #f6f8fa; }
        .modal-overlay { animation: fadeIn 0.2s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal-content { animation: slideUp 0.2s ease; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .notification { position: fixed; top: 16px; right: 16px; z-index: 9999; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="max-w-7xl mx-auto px-4 py-6">
        <header class="mb-6">
            <h1 class="text-2xl font-semibold text-gray-900 mb-1">xsukax Map Pin Generator</h1>
            <p class="text-sm text-gray-600">Create and share encrypted map pins with custom labels</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white rounded-lg border border-gray-200 overflow-hidden relative">
                <div id="map" class="w-full"></div>
                <button id="toggleFullscreen" class="fullscreen-btn"><i class="fas fa-expand"></i> Fullscreen</button>
                <div class="p-3 border-t border-gray-200 bg-gray-50">
                    <p class="text-xs text-gray-600">Click map to add pin • Click pin to remove</p>
                </div>
            </div>

            <div class="space-y-4">
                <div class="bg-white rounded-lg border border-gray-200 p-4">
                    <h2 class="text-sm font-semibold text-gray-900 mb-3">Actions</h2>
                    <div class="flex flex-wrap gap-2">
                        <button id="generateUrl" class="bg-gray-900 hover:bg-gray-800 text-white text-sm px-3 py-1.5 rounded-md transition-colors"><i class="fas fa-link mr-1.5"></i>Generate URL</button>
                        <button id="clearAll" class="bg-white hover:bg-gray-50 text-gray-900 text-sm px-3 py-1.5 rounded-md border border-gray-300 transition-colors"><i class="fas fa-trash-alt mr-1.5"></i>Clear All</button>
                    </div>
                </div>

                <div class="bg-white rounded-lg border border-gray-200 p-4">
                    <h2 class="text-sm font-semibold text-gray-900 mb-3">Pins (<span id="pinCount">0</span>)</h2>
                    <div id="pinList" class="space-y-2 max-h-96 overflow-y-auto">
                        <p class="text-sm text-gray-500 text-center py-6" id="noPinsMessage">No pins yet</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="addPinModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden modal-overlay">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4 modal-content">
            <div class="p-5">
                <h3 class="text-base font-semibold text-gray-900 mb-3">Add Pin Label</h3>
                <input type="text" id="pinLabel" placeholder="Enter label" maxlength="50" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <div class="mt-4 flex justify-end space-x-2">
                    <button id="cancelPin" class="px-3 py-1.5 text-sm text-gray-700 hover:bg-gray-100 rounded-md transition-colors">Cancel</button>
                    <button id="savePin" class="px-3 py-1.5 text-sm bg-gray-900 text-white rounded-md hover:bg-gray-800 transition-colors">Save</button>
                </div>
            </div>
        </div>
    </div>

    <div id="passwordModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden modal-overlay">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4 modal-content">
            <div class="p-5">
                <h3 class="text-base font-semibold text-gray-900 mb-3">Set Encryption Password</h3>
                <div class="mb-3">
                    <input type="password" id="encryptPassword" placeholder="Password (min 8 characters)" minlength="8" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div class="mb-3">
                    <input type="password" id="confirmPassword" placeholder="Confirm password" minlength="8" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div id="passwordError" class="hidden mb-3 p-2 bg-red-50 border border-red-200 rounded-md text-xs text-red-700"></div>
                <div class="mt-4 flex justify-end space-x-2">
                    <button id="cancelPassword" class="px-3 py-1.5 text-sm text-gray-700 hover:bg-gray-100 rounded-md transition-colors">Cancel</button>
                    <button id="savePassword" class="px-3 py-1.5 text-sm bg-gray-900 text-white rounded-md hover:bg-gray-800 transition-colors">Encrypt & Generate</button>
                </div>
            </div>
        </div>
    </div>

    <div id="decryptModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden modal-overlay">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4 modal-content">
            <div class="p-5">
                <h3 class="text-base font-semibold text-gray-900 mb-3">Enter Password</h3>
                <input type="password" id="decryptPassword" placeholder="Enter decryption password" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <div id="decryptError" class="hidden mt-3 p-2 bg-red-50 border border-red-200 rounded-md text-xs text-red-700"></div>
                <div class="mt-4 flex justify-end space-x-2">
                    <button id="cancelDecrypt" class="px-3 py-1.5 text-sm text-gray-700 hover:bg-gray-100 rounded-md transition-colors">Cancel</button>
                    <button id="decryptPins" class="px-3 py-1.5 text-sm bg-gray-900 text-white rounded-md hover:bg-gray-800 transition-colors">Decrypt</button>
                </div>
            </div>
        </div>
    </div>

    <div id="urlModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden modal-overlay">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl mx-4 modal-content">
            <div class="p-5">
                <h3 class="text-base font-semibold text-gray-900 mb-3">Shareable URL</h3>
                <div class="mb-3">
                    <textarea id="generatedUrl" readonly rows="3" class="w-full px-3 py-2 text-xs border border-gray-300 rounded-md bg-gray-50 font-mono"></textarea>
                </div>
                <div class="flex justify-end space-x-2">
                    <button id="closeModal" class="px-3 py-1.5 text-sm text-gray-700 hover:bg-gray-100 rounded-md transition-colors">Close</button>
                    <button id="openUrl" class="px-3 py-1.5 text-sm bg-white text-gray-900 border border-gray-300 rounded-md hover:bg-gray-50 transition-colors"><i class="fas fa-external-link-alt mr-1.5"></i>Open</button>
                    <button id="copyUrl" class="px-3 py-1.5 text-sm bg-gray-900 text-white rounded-md hover:bg-gray-800 transition-colors"><i class="fas fa-copy mr-1.5"></i>Copy</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const map = L.map('map').setView([20, 0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        let pins = [];
        let currentPin = null;
        let markers = [];

        const els = {
            addPinModal: document.getElementById('addPinModal'),
            passwordModal: document.getElementById('passwordModal'),
            decryptModal: document.getElementById('decryptModal'),
            urlModal: document.getElementById('urlModal'),
            pinLabel: document.getElementById('pinLabel'),
            encryptPassword: document.getElementById('encryptPassword'),
            confirmPassword: document.getElementById('confirmPassword'),
            decryptPassword: document.getElementById('decryptPassword'),
            generatedUrl: document.getElementById('generatedUrl'),
            pinList: document.getElementById('pinList'),
            noPinsMessage: document.getElementById('noPinsMessage'),
            pinCount: document.getElementById('pinCount'),
            passwordError: document.getElementById('passwordError'),
            decryptError: document.getElementById('decryptError')
        };

        map.on('click', e => {
            currentPin = { lat: e.latlng.lat, lng: e.latlng.lng, label: '' };
            els.pinLabel.value = '';
            showModal('addPinModal');
            els.pinLabel.focus();
        });

        document.getElementById('savePin').addEventListener('click', () => {
            const label = els.pinLabel.value.trim();
            if (label) {
                currentPin.label = label;
                addPin(currentPin);
                hideModal('addPinModal');
                els.pinLabel.value = '';
            }
        });

        document.getElementById('cancelPin').addEventListener('click', () => hideModal('addPinModal'));
        
        document.getElementById('savePassword').addEventListener('click', () => {
            const pass = els.encryptPassword.value;
            const confirm = els.confirmPassword.value;
            
            if (!pass || pass.length < 8) {
                showError('passwordError', 'Password must be at least 8 characters');
                return;
            }
            if (pass !== confirm) {
                showError('passwordError', 'Passwords do not match');
                return;
            }
            
            generateEncryptedUrl(pass);
        });

        document.getElementById('cancelPassword').addEventListener('click', () => hideModal('passwordModal'));
        
        document.getElementById('decryptPins').addEventListener('click', () => {
            const pass = els.decryptPassword.value;
            if (!pass) {
                showError('decryptError', 'Please enter a password');
                return;
            }
            decryptPinsFromUrl(pass);
        });

        document.getElementById('cancelDecrypt').addEventListener('click', () => hideModal('decryptModal'));
        document.getElementById('closeModal').addEventListener('click', () => hideModal('urlModal'));
        
        document.getElementById('copyUrl').addEventListener('click', () => {
            els.generatedUrl.select();
            document.execCommand('copy');
            showNotification('URL copied to clipboard', 'success');
        });

        document.getElementById('openUrl').addEventListener('click', () => {
            window.open(els.generatedUrl.value, '_blank');
        });

        document.getElementById('generateUrl').addEventListener('click', () => {
            if (pins.length === 0) {
                showNotification('Add at least one pin first', 'error');
                return;
            }
            els.encryptPassword.value = '';
            els.confirmPassword.value = '';
            hideError('passwordError');
            showModal('passwordModal');
        });

        document.getElementById('clearAll').addEventListener('click', clearAllPins);

        document.getElementById('toggleFullscreen').addEventListener('click', () => {
            const mapEl = document.getElementById('map');
            const btn = document.getElementById('toggleFullscreen');
            
            if (!document.fullscreenElement) {
                if (mapEl.requestFullscreen) mapEl.requestFullscreen();
                else if (mapEl.webkitRequestFullscreen) mapEl.webkitRequestFullscreen();
                else if (mapEl.msRequestFullscreen) mapEl.msRequestFullscreen();
                btn.innerHTML = '<i class="fas fa-compress"></i> Exit';
            } else {
                if (document.exitFullscreen) document.exitFullscreen();
                else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
                else if (document.msExitFullscreen) document.msExitFullscreen();
                btn.innerHTML = '<i class="fas fa-expand"></i> Fullscreen';
            }
        });

        document.addEventListener('fullscreenchange', () => {
            if (!document.fullscreenElement) {
                document.getElementById('toggleFullscreen').innerHTML = '<i class="fas fa-expand"></i> Fullscreen';
            }
        });

        els.pinLabel.addEventListener('keypress', e => {
            if (e.key === 'Enter') document.getElementById('savePin').click();
        });

        els.confirmPassword.addEventListener('keypress', e => {
            if (e.key === 'Enter') document.getElementById('savePassword').click();
        });

        els.decryptPassword.addEventListener('keypress', e => {
            if (e.key === 'Enter') document.getElementById('decryptPins').click();
        });

        function showModal(id) {
            els[id].classList.remove('hidden');
        }

        function hideModal(id) {
            els[id].classList.add('hidden');
            currentPin = null;
        }

        function showError(id, msg) {
            els[id].textContent = msg;
            els[id].classList.remove('hidden');
        }

        function hideError(id) {
            els[id].classList.add('hidden');
        }

        function showNotification(msg, type = 'success') {
            const notif = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-600' : 'bg-red-600';
            notif.className = `notification ${bgColor} text-white px-4 py-2 rounded-md shadow-lg text-sm`;
            notif.textContent = msg;
            document.body.appendChild(notif);
            setTimeout(() => notif.remove(), 3000);
        }

        function encryptData(data, password) {
            try {
                const salt = CryptoJS.lib.WordArray.random(16);
                const key = CryptoJS.PBKDF2(password, salt, { keySize: 8, iterations: 10000 });
                const iv = CryptoJS.lib.WordArray.random(16);
                const encrypted = CryptoJS.AES.encrypt(data, key, { iv: iv, mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.Pkcs7 });
                return CryptoJS.enc.Base64.stringify(CryptoJS.enc.Utf8.parse(salt.toString() + iv.toString() + encrypted.toString()));
            } catch (e) {
                console.error('Encryption failed:', e);
                return null;
            }
        }

        function decryptData(encryptedData, password) {
            try {
                const combined = CryptoJS.enc.Base64.parse(encryptedData).toString(CryptoJS.enc.Utf8);
                const salt = CryptoJS.enc.Hex.parse(combined.substring(0, 32));
                const iv = CryptoJS.enc.Hex.parse(combined.substring(32, 64));
                const ciphertext = combined.substring(64);
                const key = CryptoJS.PBKDF2(password, salt, { keySize: 8, iterations: 10000 });
                const decrypted = CryptoJS.AES.decrypt(ciphertext, key, { iv: iv, mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.Pkcs7 });
                return decrypted.toString(CryptoJS.enc.Utf8);
            } catch (e) {
                console.error('Decryption failed:', e);
                return null;
            }
        }

        function generateEncryptedUrl(password) {
            const data = pins.map(p => ({ l: p.label, lat: p.lat, lng: p.lng }));
            const encrypted = encryptData(JSON.stringify(data), password);
            
            if (!encrypted) {
                showError('passwordError', 'Encryption failed');
                return;
            }
            
            const url = `${window.location.href.split('?')[0]}?d=${encodeURIComponent(encrypted)}`;
            hideModal('passwordModal');
            els.generatedUrl.value = url;
            showModal('urlModal');
        }

        function decryptPinsFromUrl(password) {
            const params = new URLSearchParams(window.location.search);
            const encrypted = params.get('d');
            
            if (!encrypted) {
                showError('decryptError', 'No encrypted data in URL');
                return;
            }
            
            const decrypted = decryptData(encrypted, password);
            
            if (!decrypted) {
                showError('decryptError', 'Wrong password or corrupted data');
                return;
            }
            
            try {
                const data = JSON.parse(decrypted);
                clearAllPins();
                data.forEach(p => addPin({ label: p.l, lat: p.lat, lng: p.lng }));
                fitMapToPins();
                hideModal('decryptModal');
                showNotification('Pins decrypted successfully', 'success');
            } catch (e) {
                showError('decryptError', 'Invalid data format');
            }
        }

        function addPin(pin) {
            pins.push(pin);
            
            const icon = L.divIcon({
                className: 'custom-pin',
                html: `<div class="relative"><div class="pin-marker">${pins.length}</div><div class="pin-label">${pin.label}</div></div>`,
                iconSize: [24, 24],
                iconAnchor: [12, 12]
            });
            
            const marker = L.marker([pin.lat, pin.lng], { icon }).addTo(map);
            const mapsUrl = `https://www.google.com/maps?q=${pin.lat},${pin.lng}`;
            
            marker.bindPopup(`
                <div class="p-2">
                    <h3 class="font-semibold text-sm text-gray-900">${pin.label}</h3>
                    <p class="text-xs text-gray-600 mt-1">${pin.lat.toFixed(6)}, ${pin.lng.toFixed(6)}</p>
                    <a href="${mapsUrl}" target="_blank" class="text-blue-600 hover:text-blue-800 text-xs mt-2 inline-block"><i class="fas fa-external-link-alt mr-1"></i>Google Maps</a>
                    <br><button class="mt-2 text-red-600 text-xs hover:text-red-800 remove-pin" data-lat="${pin.lat}" data-lng="${pin.lng}">Remove Pin</button>
                </div>
            `);
            
            marker.on('popupopen', () => {
                document.querySelector('.remove-pin').addEventListener('click', function() {
                    removePin(parseFloat(this.dataset.lat), parseFloat(this.dataset.lng));
                });
            });
            
            markers.push(marker);
            
            if (pins.length === 1) {
                map.setView([pin.lat, pin.lng], 10);
            } else {
                fitMapToPins();
            }
            
            updatePinList();
        }

        function fitMapToPins() {
            if (markers.length === 0) return;
            const group = new L.featureGroup(markers);
            map.fitBounds(group.getBounds(), { padding: [20, 20] });
        }

        function removePin(lat, lng) {
            const idx = pins.findIndex(p => p.lat === lat && p.lng === lng);
            if (idx !== -1) {
                pins.splice(idx, 1);
                map.removeLayer(markers[idx]);
                markers.splice(idx, 1);
                if (pins.length > 0) fitMapToPins();
                updatePinList();
            }
        }

        function clearAllPins() {
            pins = [];
            markers.forEach(m => map.removeLayer(m));
            markers = [];
            updatePinList();
        }

        function updatePinList() {
            els.pinCount.textContent = pins.length;
            els.pinList.innerHTML = '';
            
            if (pins.length === 0) {
                els.noPinsMessage.classList.remove('hidden');
                return;
            }
            
            els.noPinsMessage.classList.add('hidden');
            
            pins.forEach(pin => {
                const mapsUrl = `https://www.google.com/maps?q=${pin.lat},${pin.lng}`;
                const el = document.createElement('div');
                el.className = 'flex justify-between items-start p-2 bg-gray-50 rounded-md border border-gray-200';
                el.innerHTML = `
                    <div class="flex-1 min-w-0">
                        <span class="font-medium text-sm text-gray-900 block truncate">${pin.label}</span>
                        <div class="text-xs text-gray-600 mt-0.5">${pin.lat.toFixed(6)}, ${pin.lng.toFixed(6)}</div>
                        <a href="${mapsUrl}" target="_blank" class="text-blue-600 hover:text-blue-800 text-xs inline-flex items-center mt-1"><i class="fas fa-external-link-alt mr-1"></i>Maps</a>
                    </div>
                    <button class="text-gray-400 hover:text-red-600 ml-2 remove-pin-list" data-lat="${pin.lat}" data-lng="${pin.lng}"><i class="fas fa-times"></i></button>
                `;
                els.pinList.appendChild(el);
            });
            
            document.querySelectorAll('.remove-pin-list').forEach(btn => {
                btn.addEventListener('click', function() {
                    removePin(parseFloat(this.dataset.lat), parseFloat(this.dataset.lng));
                });
            });
        }

        function loadPinsFromUrl() {
            const params = new URLSearchParams(window.location.search);
            if (params.get('d')) {
                hideError('decryptError');
                showModal('decryptModal');
                els.decryptPassword.focus();
            }
        }

        updatePinList();
        loadPinsFromUrl();
    </script>
</body>
</html>
